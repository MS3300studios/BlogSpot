import React, { useState } from 'react';
import axios from 'axios';
import getToken from '../../getToken';
import Flash from './flash';
import { FiSend } from 'react-icons/fi' 
import classes from './AddCommentForm.module.css';

const AddCommentForm = (props) => {
    let token = getToken();

    let userData;
        let local = localStorage.getItem('userData');
        let session = sessionStorage.getItem('userData');
        if(local !== null){
            userData = JSON.parse(local);
        }
        else if(session !== null){
            userData = JSON.parse(session);
        }

    const [statecontent, setcontent] = useState("");
    const [flashMessage, setflashMessage] = useState("");
    const [flashNotClosed, setflashNotClosed] = useState(true);

    let flash = (message) => {
        setflashMessage(message);

        setTimeout(()=>{
            setflashNotClosed(false);
        }, 2000)

        setTimeout(()=>{
            setflashMessage("");
        }, 3000);
    
        setTimeout(()=>{
            setflashNotClosed(true);
        }, 3000);
    }

    let sendComment = (e, content) => {
        window.location.reload();
        if(content === ""){
            flash("you cannot send an empty comment");
            return;
        }
        axios({
            method: 'post',
            url: `http://localhost:3001/comments/new`,
            headers: {'Authorization': token},
            data: {
                content: content,
                author: userData._id,
                blogId: props.blogId
            }
        })
        .then((res)=>{
            if(res.status===200){
                flash("you posted a comment!");
                setcontent("");
                props.afterSend();
                return;
            }
        })
        .catch(error => {
            flash(error);
            console.log(error);
        })
    }   

    let flashView = null;
    if(flashMessage && flashNotClosed){
        flashView = <Flash>{flashMessage}</Flash>
    }
    else if(flashMessage && flashNotClosed === false){
        flashView = <Flash close>{flashMessage}</Flash>
    }


    return (
        <React.Fragment>
            <div className={classes.mainContainer}>
                <form>
                    <input value={statecontent} placeholder="write your comment here" onChange={(event)=>setcontent(event.target.value)}/>
                </form>
                <div onClick={(e) => sendComment(e, statecontent)} className={classes.sendIcon}>
                    <FiSend size="2em"/>
                </div>
            </div>
            {flashView}
        </React.Fragment>
    );
}
 
export default AddCommentForm;